package com.exponea.sdk.view

import android.content.ComponentName
import android.content.Context
import android.content.res.Resources
import android.net.Uri
import android.os.Build
import android.os.Bundle
import android.util.AttributeSet
import android.view.View
import android.view.ViewGroup
import android.widget.RelativeLayout
import androidx.annotation.RequiresApi
import androidx.browser.customtabs.CustomTabsCallback
import androidx.browser.customtabs.CustomTabsClient
import androidx.browser.customtabs.CustomTabsIntent
import androidx.browser.customtabs.CustomTabsServiceConnection
import androidx.browser.customtabs.CustomTabsSession
import androidx.recyclerview.widget.RecyclerView
import androidx.viewpager2.widget.ViewPager2
import com.exponea.sdk.R
import com.exponea.sdk.databinding.InappContentBlockCarouselBinding
import com.exponea.sdk.models.ContentBlockCarouselCallback
import com.exponea.sdk.models.ContentBlockSelector
import com.exponea.sdk.services.inappcontentblock.ContentBlockCarouselViewController
import com.exponea.sdk.services.inappcontentblock.ContentBlockCarouselViewController.Companion.DEFAULT_MAX_MESSAGES_COUNT
import com.exponea.sdk.services.inappcontentblock.ContentBlockCarouselViewController.Companion.DEFAULT_SCROLL_DELAY
import com.exponea.sdk.services.inappcontentblock.ContentBlockCarouselViewController.Companion.EMPTY_PLACEHOLDER_ID
import com.exponea.sdk.services.inappcontentblock.ContentBlockCarouselViewHolder
import com.exponea.sdk.util.Logger

class ContentBlockCarouselView @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null,
    defStyleAttr: Int = 0
) : RelativeLayout(context, attrs, defStyleAttr) {

    private val binding: InappContentBlockCarouselBinding =
        InappContentBlockCarouselBinding.inflate(View.inflate(context, R.layout.inapp_content_block_carousel, this))

    public var behaviourCallback: ContentBlockCarouselCallback?
        get() = viewController.behaviourCallback
        set(value) {
            viewController.behaviourCallback = value
        }

    public var contentBlockSelector: ContentBlockSelector
        get() = viewController.contentBlockSelector
        set(value) {
            viewController.contentBlockSelector = value
        }

    private lateinit var viewPager: ViewPager2
    internal lateinit var viewController: ContentBlockCarouselViewController

    private var tabsClient: CustomTabsClient? = null
    private var tabsSession: CustomTabsSession? = null
    private val tabsCallback = object : CustomTabsCallback() {
        override fun onNavigationEvent(navigationEvent: Int, extras: Bundle?) {
            when (navigationEvent) {
                NAVIGATION_FAILED,
                TAB_HIDDEN -> {
                    Logger.i(this, "InAppCbCarousel: User returns to app")
                    viewController.onViewBecomeForeground()
                }
                else -> {
                    Logger.v(this, "InAppCbCarousel: Web Navigation event: $navigationEvent")
                }
            }
        }
    }
    private val tabsConnection = object : CustomTabsServiceConnection() {
        override fun onServiceDisconnected(name: ComponentName?) {
            tabsClient = null
            tabsSession = null
        }

        override fun onCustomTabsServiceConnected(name: ComponentName, client: CustomTabsClient) {
            tabsClient = client
            tabsClient?.warmup(0)
            tabsSession = tabsClient?.newSession(tabsCallback)
        }
    }

    init {
        val placeholderId = readPlaceholderId(context, attrs, defStyleAttr, 0)
        val maxMessagesCount = readMaxMessagesCount(context, attrs, defStyleAttr, 0)
        val scrollDelay = readScrollDelay(context, attrs, defStyleAttr, 0)
        Logger.i(this, "InAppCbCarousel: Initializing Carousel for content block placeholder ID: $placeholderId")
        if (placeholderId == EMPTY_PLACEHOLDER_ID) {
            Logger.e(this, "InAppCbCarousel: Placeholder ID is required")
        }
        this.viewController = ContentBlockCarouselViewController(
            this,
            placeholderId,
            maxMessagesCount,
            scrollDelay
        )
        this.viewPager = binding.contentBlockCarouselPager
        this.viewPager.adapter = viewController.contentBlockCarouselAdapter
        this.viewPager.registerOnPageChangeCallback(object : ViewPager2.OnPageChangeCallback() {
            override fun onPageScrollStateChanged(state: Int) {
                super.onPageScrollStateChanged(state)
                viewController.onPageScrollStateChanged(
                    state,
                    viewPager.currentItem
                )
            }
        })
        CustomTabsClient.bindCustomTabsService(
            context, CustomTabsClient.getPackageName(context, null), tabsConnection
        )
    }

    private fun readPlaceholderId(context: Context, attrs: AttributeSet?, defStyleAttr: Int, sRes: Int): String {
        val typedArray = context.obtainStyledAttributes(attrs, R.styleable.ContentBlockCarouselView, defStyleAttr, sRes)
        val placeholderId = typedArray.getString(R.styleable.ContentBlockCarouselView_placeholderId)
        typedArray.recycle()
        return placeholderId ?: EMPTY_PLACEHOLDER_ID
    }

    private fun readMaxMessagesCount(context: Context, attrs: AttributeSet?, defStyleAttr: Int, sRes: Int): Int {
        val typedArray = context.obtainStyledAttributes(attrs, R.styleable.ContentBlockCarouselView, defStyleAttr, sRes)
        val maxMessagesCount = typedArray.getInt(
            R.styleable.ContentBlockCarouselView_maxMessagesCount,
            DEFAULT_MAX_MESSAGES_COUNT
        )
        typedArray.recycle()
        return maxMessagesCount
    }

    private fun readScrollDelay(context: Context, attrs: AttributeSet?, defStyleAttr: Int, sRes: Int): Int {
        val typedArray = context.obtainStyledAttributes(attrs, R.styleable.ContentBlockCarouselView, defStyleAttr, sRes)
        val scrollDelay = typedArray.getInt(R.styleable.ContentBlockCarouselView_scrollDelay, DEFAULT_SCROLL_DELAY)
        typedArray.recycle()
        return scrollDelay
    }

    internal fun recalculateHeightIfNeeded(onlyCurrentView: Boolean) {
        if (onlyCurrentView) {
            Logger.v(this, "InAppCbCarousel: Recalculating height for current view")
        } else {
            Logger.v(this, "InAppCbCarousel: Recalculating height for current view and views around it")
        }
        if (layoutParams == null || layoutParams.height != ViewGroup.LayoutParams.WRAP_CONTENT) {
            Logger.v(this, "InAppCbCarousel: Auto-height is not set, skipping")
            return
        }
        val viewHolderScope = collectActivePlaceholderViews(onlyCurrentView)
        val planned = post {
            val highestValue = viewHolderScope.map {
                it.measure(
                    MeasureSpec.makeMeasureSpec(it.width, MeasureSpec.EXACTLY),
                    MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED)
                )
                Logger.v(
                    this,
                    "InAppCbCarousel: Auto-height feature detects height: ${it.measuredHeight}"
                )
                it.measuredHeight
            }.maxOrNull()
            Logger.v(this, "InAppCbCarousel: Max height of content block is: $highestValue")
            highestValue?.let {
                if (viewPager.layoutParams.height != it) {
                    viewPager.layoutParams = viewPager.layoutParams.apply {
                        height = it
                    }
                }
            }
        }
        if (!planned) {
            Logger.w(this, "InAppCbCarousel: Auto-height feature disabled, view is exiting")
        }
    }

    private fun collectActivePlaceholderViews(onlyCurrentView: Boolean): List<InAppContentBlockPlaceholderView> {
        val result = mutableListOf<InAppContentBlockPlaceholderView>()
        val innerRecyclerView = viewPager.getChildAt(0)
        if (innerRecyclerView !is RecyclerView) {
            Logger.w(this, "InAppCbCarousel: Auto-height feature disabled, inner view is not a RecyclerView")
            return result
        }
        if (!onlyCurrentView) {
            (innerRecyclerView.findViewHolderForLayoutPosition(viewPager.currentItem - 1)
                    as? ContentBlockCarouselViewHolder)?.getContentBlockPlaceholderView()?.let {
                result.add(it)
            }
        }
        (innerRecyclerView.findViewHolderForLayoutPosition(viewPager.currentItem)
                as? ContentBlockCarouselViewHolder)?.getContentBlockPlaceholderView()?.let {
            result.add(it)
        }
        if (!onlyCurrentView) {
            (innerRecyclerView.findViewHolderForLayoutPosition(viewPager.currentItem + 1)
                    as? ContentBlockCarouselViewHolder)?.getContentBlockPlaceholderView()?.let {
                result.add(it)
            }
        }
        return result
    }

    // Other methods (reload, getShownContentBlock, etc.) remain as in the original code.
}
